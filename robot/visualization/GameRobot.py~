from robot.robot import Robot
import numpy as np

class GameRobot:

    def __init__(self):
        self.m2p = 3779.52
        self.width = 0.5
        self.x = 0
        self.y = 0

        self.heading = 0

        self.vl = 0.01 * self.m2p
        self.vr = 0.01 * self.m2p

        self.minspeed = 0
        self.maxspeed = 0.02 * self.m2p
        self.min_obs_dist = 100
        self.count_down = 5

    def avoid_obstacle(self, point_cloud, dt):
        closest_obs = None
        dist = np.inf

        if len(point_cloud) > 1:
            for point in point_cloud:
                if dist > self.distance([self.x, self.y], point):
                    dist = self.distance([self.x, self.y], point)
                    closest_obs = (point, dist)


            if closest_obs < self.min_obs_dist and self.count_down > 0:
                self.count_down -= dt
                self.set_wheel_speed(-self.minspeed, -self.minspeed)
            else:
                pass

    def set_wheel_speed(self, vl, vr):
        self.vl = vl
        self.vr = vr

    def kinematics(self, dt):

        # Вычисляем линейную и угловую скорости
        linear_velocity = (self.vr + self.vl) / 2
        angular_velocity = (self.vr - self.vl) / self.width

        # Обновляем позицию и ориентацию
        self.x += linear_velocity * np.cos(self.heading) * dt
        self.y += linear_velocity * np.sin(self.heading) * dt
        self.heading += angular_velocity * dt

        # Нормализуем угол в диапазоне [0, 2π]
        self.heading = self.heading % (2 * np.pi)

        self



    def distance(self, point1, point2):
        point1 = np.array(point1)
        point2 = np.array(point2)
        return np.linalg.norm(point1 - point2)